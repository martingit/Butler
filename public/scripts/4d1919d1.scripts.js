"use strict";angular.module("butlerApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{title:"Butler",templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{title:"About",templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/schedule",{title:"Schedule",templateUrl:"views/schedule.html",controller:"ScheduleCtrl"}).when("/settings",{title:"Settings",templateUrl:"views/settings.html",controller:"SettingsCtrl"}).otherwise({redirectTo:"/"})}]).run(["$location","$rootScope",function(a,b){b.$on("$routeChangeSuccess",function(a,c){b.title=c.$$route.title})}]).directive("scheduleList",function(){return{restrict:"E",templateUrl:"views/partials/scheduleList.html",controller:"ScheduleCtrl"}}).directive("queueList",function(){return{restrict:"E",templateUrl:"views/partials/queueList.html",controller:"QueueCtrl"}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).factory("AppAlert",["$rootScope","$timeout",function(a,b){var c;return a.alerts=[],c={add:function(d,e,f){a.alerts.push({type:d,msg:e,close:function(){return c.closeAlert(this)}}),f&&b(function(){c.closeAlert(this)},f)},closeAlert:function(b){return this.closeAlertIdx(a.alerts.indexOf(b))},closeAlertIdx:function(b){return a.alerts.splice(b,1)}}}]),angular.module("butlerApp").controller("MainCtrl",["$scope",function(){}]),angular.module("butlerApp").controller("AboutCtrl",["$scope",function(){}]),angular.module("butlerApp").controller("DeviceCtrl",["$scope","$http","$log","AppAlert",function(a,b,c,d){b.get("/device/").success(function(b){a.devices=b.devices}).error(function(a){c.error(a),d.add("danger",a,2e3)}),a.dimLevels=[0,10,20,30,40,50,60,70,80,90,100],a.changeStatus=function(e,f){angular.forEach(a.devices,function(a){if(a.id===e){var g="/device/";return void b.post(g,{status:f,deviceId:e}).success(function(b){a.status=b.status,a.status?d.add("info","Turned on device "+a.name,2e3):d.add("info","Turned off device "+a.name,2e3)}).error(function(a){c.error(a),d.add("danger",a,2e3)})}})},a.turnAllOff=function(){angular.forEach(a.devices,function(a){var e="/device/";b.post(e,{status:!1,deviceId:a.id}).success(function(b){a.status=b.status}).error(function(a){c.error(a),d.add("danger",a,2e3)})}),d.add("info","Turned off all devices",2e3)},a.turnAllOn=function(){angular.forEach(a.devices,function(a){var e="/device/";b.post(e,{status:!0,deviceId:a.id}).success(function(b){a.status=b.status}).error(function(a){c.error(a),d.add("danger",a,2e3)})}),d.add("info","Turned on all devices",2e3)},a.dimDevice=function(e,f){c.info("Device: "+e+" Level: "+f),angular.forEach(a.devices,function(a){if(a.id===e){var g="/device/";return void b.put(g,{level:f,deviceId:e}).success(function(b){a.status=b.status,a.level=b.level,d.add("info","Dimmed "+a.name+" to "+a.level+"%",2e3)}).error(function(a){c.error(a),d.add("danger",a,2e3)})}})},a.reloadDevices=function(){b.get("/device/reload").success(function(b){a.devices=b.devices}).error(function(a){c.error(a),d.add("danger",a,2e3)})}}]).directive("deviceList",function(){return{restrict:"E",templateUrl:"views/partials/deviceList.html",controller:"DeviceCtrl"}}),angular.module("butlerApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.nodes=[{name:"Home",url:"/",icon:"glyphicon glyphicon-home"},{name:"Schedule",url:"/schedule",icon:"glyphicon glyphicon-time"},{name:"Settings",url:"/settings",icon:"glyphicon glyphicon-cog"},{name:"About",url:"/about",icon:"glyphicon glyphicon-heart-empty"}],a.isActive=function(a){return a===b.path()}}]).directive("butlerHeader",function(){return{restrict:"E",templateUrl:"views/partials/header.html",controller:"HeaderCtrl"}}),angular.module("butlerApp").controller("ScheduleCtrl",["$scope","$http","$rootScope","$log","AppAlert",function(a,b,c,d,e){a.schedules=void 0,a.timeTypes=[{value:0,name:"Absolute"},{value:1,name:"Sunrise +"},{value:2,name:"Sunrise -"},{value:3,name:"Sunset +"},{value:4,name:"Sunset -"}],a.actions=[{value:!0,name:"On"},{value:!1,name:"Off"}];var f=function(){a.newSchedule={id:"",deviceId:null,timeTypeId:0,time:null,action:!0,enabled:!0}},g=function(){c.$broadcast("handleScheduleSaved")};a.reloadSchedule=function(c){d.info("reloading schedule and devices"),c||b.get("/device/").success(function(b){a.devices=b.devices}).error(function(a){d.error(a)}),b.get("/schedule/").success(function(b){d.info(b),a.schedules=b.items}).error(function(a){d.error(a)})};var h=function(a){var b=/^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/;return b.test(a)?!0:(e.add("danger","Please enter time in correct format (hh:mm)",3e3),!1)};a.add=function(){if(!a.newSchedule.deviceId)return void e.add("danger","Please select a device",3e3);if(h(a.newSchedule.time)){var c="/schedule";b.put(c,a.newSchedule).success(function(b){d.info(b),a.schedules.push(b),f(),g()}).error(function(a){d.error(a)})}},a.update=function(c){for(var e=-1,f=0;f<a.schedules.length;f++)a.schedules[f].id===c&&(e=f);if(-1!==e){var i="/schedule/",j=a.schedules[e];h(j.time)&&b.post(i,j).success(function(b){d.info(b),a.schedules[e].dirty=null,g()}).error(function(a){d.error(a)})}},a.delete=function(c){d.info("delete item "+c);for(var e="/schedule/"+c,f=-1,h=0;h<a.schedules.length;h++)a.schedules[h].id===c&&(f=h);d.info("index:"+f),b.delete(e).success(function(b){d.info(b),a.schedules.splice(f,1),g()}).error(function(a){d.error(a)})},a.saveAll=function(){d.info("save all");for(var b=0;b<a.schedules.length;b++)a.schedules[b].dirty&&a.update(a.schedules[b].id),a.$apply()},f(),a.reloadSchedule(!1)}]),google.load("visualization","1",{packages:["timeline"]}),angular.module("butlerApp").controller("QueueCtrl",["$scope","$http","$interval","$log","AppAlert",function(a,b,c,d,e){a.createTimeline=function(){b.get("/schedule/timeline").success(function(a){if(d.info(a),a.items&&a.items.length>0){var b=new google.visualization.DataTable;b.addColumn({type:"string",id:"Name"}),b.addColumn({type:"date",id:"Start"}),b.addColumn({type:"date",id:"End"});for(var c=0;c<a.items.length;c++){var e=a.items[c];b.addRow([e.deviceName,moment.utc(e.start).toDate(),moment.utc(e.end).toDate()])}var f={title:"Timeline",enableInteractivity:!0,timeline:{showRowLabels:!0,singleColor:"#428BCA"},hAxis:{format:"HH:mm"},is3D:!0},g=new google.visualization.Timeline(document.getElementById("timelineChart"));g.draw(b,f)}}).error(function(a){d.error(a)})};var f;a.reloadQueues=function(){d.info("reloading queues"),b.get("/queue/reload").success(function(b){a.queues=b.items}).error(function(a){d.error(a),e.add("danger",a,3e3)})},a.loadQueues=function(){d.info("loading queues"),b.get("/queue").success(function(b){a.queues=b.items}).error(function(a){d.error(a),e.add("danger","Could not load queue. Stopping automatic reload timer.",3e3),f&&c.cancel(f)})},a.$on("handleScheduleSaved",function(){a.loadQueues(),a.createTimeline()}),a.$on("$destroy",function(){f&&c.cancel(f)}),f=c(a.loadQueues,1e4),a.loadQueues(),a.createTimeline()}]),angular.module("butlerApp").controller("SettingsCtrl",["$scope","$http","$log","$timeout","$window","AppAlert",function(a,b,c,d,e,f){a.address="";var g=function(){b.get("/settings/").success(function(b){a.settings=b}).error(function(a){c.error(a)})};a.getUserLocation=function(){c.info("get user location"),navigator.geolocation&&(c.info("user location available"),navigator.geolocation.getCurrentPosition(function(b){c.info(b.coords),a.settings.longitude=b.coords.longitude,a.settings.latitude=b.coords.latitude,f.add("info","Geolocation retrieved from browser!",2e3),a.$apply()},function(a){switch(a.code){case a.PERMISSION_DENIED:f.add("danger","User denied the request for Geolocation.",3e3);break;case a.POSITION_UNAVAILABLE:f.add("danger","Location information is unavailable.",3e3);break;case a.TIMEOUT:f.add("danger","The request to get user location timed out.",3e3);break;case a.UNKNOWN_ERROR:f.add("danger","An unknown error occurred.",3e3)}}))},a.saveSettings=function(){c.info("saving settings"),b.post("/settings",a.settings).success(function(a){f.add("success","Settings saved successfully!",2e3),c.info(a)}).error(function(a){c.error(a),f.add("danger",a)})},a.reloadSettings=function(){g(),a.$apply()},a.getGeolocationFromAddress=function(){if(0!==a.address.length){var d=a.address;c.info(d);var e="http://maps.googleapis.com/maps/api/geocode/json?address="+d+"&sensor=false";b.get(e).success(function(b){"OK"===b.status&&b.results.length>0&&(a.settings.longitude=b.results[0].geometry.location.lng,a.settings.latitude=b.results[0].geometry.location.lat,a.address=b.results[0].formatted_address)}).error(function(a){c.error(a),f.add("danger",a)})}},a.restartServer=function(){var g="Restart http server on port "+a.settings.httpServerPort;c.info(g),f.add("warning",g,5e3);var h=a.settings.isSecureServer?"https:":"http:",i=h+"//"+e.location.hostname+":"+a.settings.httpServerPort+"/";b.put("/settings/restart").success(function(a){c.info(a),d(function(){e.location=i},2e3,!1)}).error(function(a){c.error(a)})},g()}]);